<!DOCTYPE html>
<html>
  <head>
    <script>
      // Support for having this be an embedded widget of some sort
      function calculatorRoot() {
        return document.body;
      }

      var initialChildInfoChildElementCount; // initialized onload.
      function childEntryCount(childInfo) {
        // Subtract 1, because we have the <legend> in there.
        /* compat issue: old browsers don't have .childElementCount */
        return childInfo.childElementCount - initialChildInfoChildElementCount;
      }

      function ensureChildInfoCount(numChildren) {
        var childInfo = calculatorRoot().querySelector("#childInfo");
        while (childEntryCount(childInfo) > numChildren) {
          /* compat issue: old browsers don't have remove(). */
          childInfo.lastChild.remove();
        }
        var childTemplate = calculatorRoot().querySelector("#oneChild").content;
        while (childEntryCount(childInfo) < numChildren) {
          childNumber = childEntryCount(childInfo) + 1;
          var child = childTemplate.cloneNode(true);
          child.querySelector(".childNumber").textContent = childNumber;
          child.querySelector(".currentYear").textContent = (new Date).getFullYear();
          /* compat issue: old browsers don't have for-of loops. */
          for (node of child.querySelectorAll("input[name]")) {
            node.name += childNumber;
          }
          childInfo.appendChild(child);
        }
      }

      function restoreInputs(names, params) {
        /* compat issue: old browsers don't support for-of loops. */
        for (var inputName of names) {
          /* compat issue: old browsers don't support `` strings. */
          calculatorRoot().querySelector(`input[name=${inputName}]`).value =
            params.get(inputName);
        }
      }
      function restoreStateFromLocation() {
        /* compat issue: old browsers don't have URLSearchParams */
        var params = new URLSearchParams(location.search.substring(1));
        numChildren = params.get("childcount");
        calculatorRoot().querySelector("input[name=childcount]").value = numChildren;
        numChildren = parseInt(numChildren);
        ensureChildInfoCount(numChildren);
        for (child = 1; child <= numChildren; ++child) {
          /* compat issue: old browsers don't support `` strings. */
          restoreInputs([`matriculation-${child}`, `years-${child}`,
                         `collegecost-${child}`],
                        params);
        }

        restoreInputs(["tuition-inflation"], params);
      }

      window.onload = function() {
        /* compat issue: old browsers don't have .childElementCount */
        initialChildInfoChildElementCount =
          calculatorRoot().querySelector("#childInfo").childElementCount;
        if (!location.search) {
          // Nothing to initialize with.
          return
        }

        restoreStateFromLocation();
        calculate();
      }

      function calculate() {
      }
    </script>
    <style>
      .oneChild > label { display: block }
    </style>
  </head>
  <body>
    <!-- compat issue: old browsers don't have <template> elements -->
    <template id="oneChild">
      <fieldset class="oneChild">
        <legend>Child <span class="childNumber"></span></legend>
        <label>
          Year child will start college:
          <input required name="matriculation-" type="number">
        </label> 
        <label>
          Years in college:
          <input required name="years-" type="number" min="1">
        </label>
        <label>
          Annual cost of desired college type in <span class="currentYear"></span>:
          $<input required name="collegecost-" type="number">
        </label>
      </fieldset>
    </template>
    <form action="">
      <fieldset id="childInfo">
        <legend>
          <label>
            Number of children:
            <input required type="number" name="childcount"
                   onchange="ensureChildInfoCount(this.value)">
          </label>
        </legend>
      </fieldset>
      <fieldset id="costs">
        <legend>Costs</legend>
        Annual inflation-adjusted tuition increase:
        <input type="number" required step="0.1" value="6"
               name="tuition-inflation">%.
      </fieldset>
      <input type="submit" value="Calculate">
    </form>
  </body>
</html>
